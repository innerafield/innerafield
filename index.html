<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="description" content="Find your purpose. Connect to Source. For all beings. For peace.">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Innera Field</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --void:#000;
  --light:#fff;
  --dim:rgba(255,255,255,.5);
  --faint:rgba(255,255,255,.25);
  --glass:rgba(255,255,255,.03);
  --border:rgba(255,255,255,.08);
  --pink:rgba(255,20,147,.35);
  --blue:rgba(0,191,255,.35);
  --purple:rgba(138,43,226,.3);
  --gold:rgba(255,215,0,.4);
}

html,body{
  width:100%;
  height:100%;
  overflow:hidden;
}

body{
  font-family:Inter,-apple-system,sans-serif;
  background:var(--void);
  color:var(--light);
  display:flex;
  align-items:center;
  justify-content:center;
  -webkit-tap-highlight-color:transparent;
  animation:awakening 1.5s ease-out;
}

@keyframes awakening{
  0%{opacity:0}
  100%{opacity:1}
}

/* Cosmic background - optimized */
.cosmos{
  position:fixed;
  inset:0;
  z-index:0;
  background:
    radial-gradient(ellipse at 30% 20%,var(--pink),transparent 50%),
    radial-gradient(ellipse at 70% 80%,var(--blue),transparent 50%),
    radial-gradient(circle at 50% 50%,var(--purple),transparent 60%);
  opacity:.3;
  animation:cosmicPulse 12s ease-in-out infinite;
  pointer-events:none;
}

@keyframes cosmicPulse{
  0%,100%{opacity:.25}
  50%{opacity:.4}
}

/* Main container */
.field{
  position:relative;
  z-index:1;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:1.5rem;
  text-align:center;
}

/* Title */
.title{
  position:absolute;
  top:max(10vh,55px);
  font-size:clamp(1.2rem,4vw,1.9rem);
  font-weight:600;
  letter-spacing:.65em;
  padding-left:.65em;
  background:linear-gradient(135deg,#ff1493,#00bfff,#8a2be2,#ff1493);
  background-size:300% 300%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:titleShimmer 10s ease-in-out infinite;
  user-select:none;
}

@keyframes titleShimmer{
  0%,100%{background-position:0% 50%}
  50%{background-position:100% 50%}
}

/* Controls - top right - modern, no circles */
.controls{
  position:absolute;
  top:max(3vh,16px);
  right:max(3vw,16px);
  display:flex;
  gap:.8rem;
  z-index:100;
}

.ctrl{
  background:transparent;
  border:none;
  color:var(--dim);
  font-size:1.1rem;
  cursor:pointer;
  transition:all .25s ease;
  padding:.4rem;
  opacity:.5;
}

.ctrl:hover{
  opacity:1;
  color:var(--light);
}

.ctrl.on{
  opacity:1;
  color:#ff1493;
}

/* The Circle - optimized for mobile */
.circle{
  position:relative;
  width:min(240px,58vw);
  height:min(240px,58vw);
  border-radius:50%;
  background:radial-gradient(circle at 40% 35%,rgba(255,20,147,.04),transparent 60%);
  border:2px solid var(--border);
  box-shadow:0 0 60px var(--pink);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  cursor:pointer;
  transform:translateZ(0);
  will-change:transform,box-shadow;
  transition:transform 4s ease-out,box-shadow 4s ease-out,border-color 2s ease;
}

.circle:not(.breathing){
  animation:heartbeat 5s ease-in-out infinite;
}

@keyframes heartbeat{
  0%,100%{transform:scale(1);box-shadow:0 0 60px var(--pink)}
  50%{transform:scale(1.02);box-shadow:0 0 80px var(--pink)}
}

.circle:hover:not(.breathing){border-color:rgba(255,255,255,.15)}
.circle:focus{outline:none}
.circle:focus-visible{outline:2px solid rgba(255,255,255,.25);outline-offset:10px}

/* Breathing states - optimized single shadows */
.circle.breathing.inhale{
  transform:scale(1.3);
  border-color:rgba(255,215,0,.35);
  box-shadow:0 0 100px var(--gold);
}

.circle.breathing.hold-in{
  transform:scale(1.3);
  border-color:rgba(255,180,150,.3);
  box-shadow:0 0 90px rgba(255,180,150,.35);
}

.circle.breathing.exhale{
  transform:scale(0.78);
  border-color:rgba(0,191,255,.3);
  box-shadow:0 0 50px var(--blue);
}

.circle.breathing.hold-out{
  transform:scale(0.78);
  border-color:rgba(138,43,226,.3);
  box-shadow:0 0 45px var(--purple);
}

/* Circle text */
.word{
  font-size:clamp(.9rem,3vw,1.15rem);
  font-weight:300;
  letter-spacing:.32em;
  padding-left:.32em;
  text-transform:uppercase;
  opacity:.85;
  transition:all 1s ease;
  user-select:none;
}

.hint{
  font-size:.7rem;
  font-weight:300;
  letter-spacing:.15em;
  margin-top:.6rem;
  opacity:.35;
  transition:opacity 1s ease;
  color:var(--dim);
}

.breathing .hint{opacity:0}

.phase{
  font-size:clamp(.68rem,2vw,.8rem);
  font-weight:300;
  letter-spacing:.18em;
  margin-top:.5rem;
  opacity:0;
  transition:opacity 1s ease;
  color:var(--dim);
}

.breathing .phase{opacity:1}

.timer{
  font-size:.6rem;
  letter-spacing:.12em;
  margin-top:.4rem;
  opacity:0;
  color:var(--faint);
  transition:opacity 1s ease;
}

.breathing .timer{opacity:1}

/* Wisdom area */
.wisdom-area{
  position:absolute;
  bottom:max(13vh,80px);
  text-align:center;
  max-width:min(85%,380px);
}

.wisdom{
  font-size:clamp(.75rem,2vw,.88rem);
  font-weight:300;
  letter-spacing:.08em;
  line-height:1.8;
  opacity:0;
  transition:opacity 2s ease;
  font-style:italic;
  color:rgba(255,255,255,.4);
}

.active .wisdom{opacity:1}

.session-msg{
  margin-top:1rem;
  font-size:.75rem;
  letter-spacing:.15em;
  opacity:0;
  color:var(--dim);
  transition:opacity 1.5s ease;
  line-height:1.8;
}

.session-msg.show{opacity:1}

.session-msg .count{
  color:rgba(255,20,147,.7);
}

/* Energy exchange */
.energy{
  position:absolute;
  bottom:max(4vh,18px);
  font-size:.68rem;
  letter-spacing:.12em;
  opacity:.2;
  transition:opacity .4s ease;
  color:var(--dim);
  display:flex;
  align-items:center;
  gap:.6rem;
}

.energy:hover{opacity:.5}

.energy span{opacity:.6}

.energy-btn{
  background:none;
  border:none;
  color:inherit;
  font-size:.85rem;
  cursor:pointer;
  padding:.3rem;
  opacity:.7;
  transition:all .3s;
}

.energy-btn:hover{
  opacity:1;
  color:var(--light);
  transform:scale(1.1);
}

/* Toast notification */
.toast{
  position:fixed;
  bottom:15%;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:rgba(0,0,0,.9);
  border:1px solid var(--border);
  padding:.8rem 1.5rem;
  border-radius:8px;
  font-size:.75rem;
  letter-spacing:.1em;
  opacity:0;
  pointer-events:none;
  transition:all .4s ease;
  z-index:300;
}

.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* Donation modal */
.donate-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  z-index:250;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:opacity .4s ease;
}

.donate-modal.show{
  opacity:1;
  pointer-events:auto;
}

.donate-content{
  background:rgba(20,20,20,.95);
  border:1px solid var(--border);
  border-radius:12px;
  padding:2rem;
  text-align:center;
  max-width:min(90%,320px);
}

.donate-content h3{
  font-size:.8rem;
  font-weight:400;
  letter-spacing:.2em;
  margin-bottom:1.5rem;
  color:var(--dim);
}

.donate-qr{
  width:150px;
  height:150px;
  margin:0 auto 1rem;
  background:#fff;
  border-radius:8px;
  padding:8px;
}

.donate-qr img{
  width:100%;
  height:100%;
}

.donate-address{
  font-size:.6rem;
  letter-spacing:.05em;
  color:var(--faint);
  word-break:break-all;
  margin-bottom:1rem;
  padding:.8rem;
  background:var(--glass);
  border-radius:6px;
  cursor:pointer;
  transition:all .3s;
}

.donate-address:hover{
  background:rgba(255,255,255,.08);
  color:var(--light);
}

.donate-close{
  background:none;
  border:1px solid var(--border);
  color:var(--dim);
  padding:.6rem 1.5rem;
  font-size:.7rem;
  letter-spacing:.15em;
  cursor:pointer;
  border-radius:6px;
  transition:all .3s;
}

.donate-close:hover{
  border-color:rgba(255,255,255,.2);
  color:var(--light);
}

/* Menu panel */
.menu{
  position:fixed;
  top:0;
  right:-300px;
  width:min(280px,85vw);
  height:100%;
  background:rgba(5,5,5,.95);
  border-left:1px solid var(--border);
  z-index:200;
  transition:right .35s ease-out;
  overflow-y:auto;
  padding:1.5rem;
}

.menu.open{right:0}

.menu-close{
  position:absolute;
  top:1rem;
  right:1rem;
  background:none;
  border:none;
  color:var(--dim);
  font-size:1.3rem;
  cursor:pointer;
  transition:color .3s;
  padding:.3rem;
}

.menu-close:hover{color:var(--light)}

.menu h3{
  font-size:.65rem;
  font-weight:400;
  letter-spacing:.22em;
  color:var(--faint);
  margin:1.8rem 0 .7rem;
  text-transform:uppercase;
}

.menu h3:first-of-type{margin-top:.8rem}

.menu-item{
  display:flex;
  align-items:center;
  padding:.65rem .9rem;
  margin:.25rem 0;
  background:transparent;
  border:1px solid transparent;
  border-radius:6px;
  cursor:pointer;
  transition:all .25s ease;
  font-size:.78rem;
  color:var(--dim);
}

.menu-item:hover{
  background:var(--glass);
  color:var(--light);
}

.menu-item.selected{
  border-color:rgba(255,20,147,.25);
  background:rgba(255,20,147,.06);
  color:var(--light);
}

.menu-item .dot{
  width:6px;
  height:6px;
  border-radius:50%;
  margin-right:.8rem;
  background:var(--border);
  transition:all .25s;
}

.menu-item.selected .dot{
  background:#ff1493;
  box-shadow:0 0 8px rgba(255,20,147,.5);
}

.menu-divider{
  height:1px;
  background:var(--border);
  margin:1.2rem 0;
}

.time-row{
  display:flex;
  gap:.35rem;
}

.time-btn{
  flex:1;
  padding:.55rem .3rem;
  background:transparent;
  border:1px solid transparent;
  border-radius:6px;
  color:var(--dim);
  font-size:.72rem;
  cursor:pointer;
  transition:all .25s;
}

.time-btn:hover{background:var(--glass);color:var(--light)}
.time-btn.selected{border-color:rgba(255,20,147,.25);background:rgba(255,20,147,.06);color:var(--light)}

.toggle-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:.6rem 0;
  font-size:.78rem;
  color:var(--dim);
}

.toggle{
  width:38px;
  height:20px;
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:10px;
  cursor:pointer;
  position:relative;
  transition:all .3s;
}

.toggle::after{
  content:'';
  position:absolute;
  top:3px;
  left:3px;
  width:12px;
  height:12px;
  background:var(--dim);
  border-radius:50%;
  transition:all .3s;
}

.toggle.on{
  background:rgba(255,20,147,.15);
  border-color:rgba(255,20,147,.35);
}

.toggle.on::after{
  left:21px;
  background:#ff1493;
}

/* Overlay */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:150;
  opacity:0;
  pointer-events:none;
  transition:opacity .35s;
}

.overlay.show{opacity:1;pointer-events:auto}

/* Screen reader */
.sr{
  position:absolute;
  width:1px;height:1px;
  padding:0;margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  border:0;
}

/* High contrast */
body.contrast .circle{border:2px solid #fff;box-shadow:0 0 30px rgba(255,255,255,.2)}
body.contrast .word,body.contrast .phase,body.contrast .wisdom,body.contrast .title{
  -webkit-text-fill-color:#fff;color:#fff;opacity:1;
}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){
  *{animation:none!important;transition-duration:.15s!important}
}

/* Mobile optimizations */
@media(max-width:500px){
  .circle{width:min(200px,55vw);height:min(200px,55vw)}
  .title{top:max(7vh,40px);font-size:clamp(1rem,3.5vw,1.5rem)}
  .wisdom-area{bottom:max(11vh,65px)}
  .controls{top:max(2vh,10px);right:max(2vw,10px);gap:.6rem}
  .ctrl{font-size:1rem}
}
</style>
</head>
<body>

<div class="cosmos"></div>

<div class="field">
  <h1 class="title">INNERA FIELD</h1>

  <div class="controls">
    <button class="ctrl" id="soundBtn" aria-label="Sound" aria-pressed="false" title="Sound">◉</button>
    <button class="ctrl" id="contrastBtn" aria-label="High contrast" aria-pressed="false" title="Contrast">◐</button>
    <button class="ctrl" id="menuBtn" aria-label="Open menu" title="Menu">≡</button>
  </div>

  <div class="circle" id="circle" role="button" tabindex="0" aria-label="Breathing circle. Tap to begin.">
    <span class="word" id="word">breathe</span>
    <span class="hint" id="hint">tap to begin</span>
    <span class="phase" id="phase"></span>
    <span class="timer" id="timerDisplay"></span>
  </div>

  <div class="wisdom-area">
    <p class="wisdom" id="wisdom"></p>
    <p class="session-msg" id="sessionMsg"></p>
  </div>

  <div class="energy">
    <span>if this serves you</span>
    <a class="energy-btn" href="https://ko-fi.com/innerafield" target="_blank" rel="noopener" title="Ko-fi">♡</a>
    <button class="energy-btn" id="btcBtn" title="Bitcoin">₿</button>
    <button class="energy-btn" id="ethBtn" title="Ethereum">Ξ</button>
  </div>

  <div class="sr" id="sr" role="status" aria-live="assertive"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Donation Modal -->
<div class="donate-modal" id="donateModal">
  <div class="donate-content">
    <h3 id="donateTitle">BITCOIN</h3>
    <div class="donate-qr">
      <img id="donateQR" src="" alt="QR Code">
    </div>
    <div class="donate-address" id="donateAddress" title="Click to copy"></div>
    <button class="donate-close" id="donateClose">close</button>
  </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Menu -->
<nav class="menu" id="menu" aria-label="Settings">
  <button class="menu-close" id="menuClose" aria-label="Close menu">×</button>

  <h3>Journey</h3>
  <div class="menu-item selected" data-journey="heart"><span class="dot"></span>Heart Opening</div>
  <div class="menu-item" data-journey="awakening"><span class="dot"></span>Awakening</div>
  <div class="menu-item" data-journey="grounding"><span class="dot"></span>Grounding</div>
  <div class="menu-item" data-journey="unity"><span class="dot"></span>Unity</div>
  <div class="menu-item" data-journey="peace"><span class="dot"></span>Deep Peace</div>

  <div class="menu-divider"></div>

  <h3>Duration</h3>
  <div class="time-row">
    <button class="time-btn" data-time="300">5 min</button>
    <button class="time-btn selected" data-time="600">10 min</button>
    <button class="time-btn" data-time="1200">20 min</button>
    <button class="time-btn" data-time="0">∞</button>
  </div>

  <div class="menu-divider"></div>

  <h3>Options</h3>
  <div class="toggle-row">
    <span>Voice guidance</span>
    <div class="toggle" id="voiceToggle" role="switch" aria-checked="false"></div>
  </div>
</nav>

<script>
(function(){
'use strict';

// ══════════════════════════════════════════════════════════
// CRYPTO ADDRESSES
// ══════════════════════════════════════════════════════════
const CRYPTO = {
  btc: 'bc1qwjsvjg0ckfw2aa9c5zdhc4ewxn7yse8lvstuaz',
  eth: '0x12e10C6aA1557A9B13c570c0070E223aec8dE498'
};

// ══════════════════════════════════════════════════════════
// JOURNEY-SPECIFIC WISDOM
// ══════════════════════════════════════════════════════════
const WISDOMS = {
  heart: [
    "you are worthy of love. you always have been.",
    "your heart knows the way. trust it.",
    "love is not earned. it is remembered.",
    "you are not broken. you are returning.",
    "the heart that seeks connection is already connected.",
    "every heartbeat is a prayer answered."
  ],
  awakening: [
    "consciousness is not found. it is unveiled.",
    "you are not becoming aware. you are awareness itself.",
    "the truth you seek is seeking you.",
    "awakening is not an event. it is a recognition.",
    "you have always been the light you're looking for.",
    "stillness speaks louder than thought."
  ],
  grounding: [
    "you are held by the earth. always.",
    "your body is your first home. return to it.",
    "presence is the anchor. breath is the chain.",
    "the ground beneath you is sacred ground.",
    "you belong here. you have always belonged.",
    "root down to rise up."
  ],
  unity: [
    "separation is the illusion. oneness is the truth.",
    "you are the field. the field is you.",
    "there is no other. there is only one.",
    "peace begins when we remember we are one.",
    "every breath connects you to all beings.",
    "in unity, there is no war. only love."
  ],
  peace: [
    "peace is not found. it is remembered.",
    "stillness is your nature. return to it.",
    "in the quiet, God speaks.",
    "surrender is not giving up. it is opening up.",
    "rest is not weakness. it is wisdom.",
    "the deepest peace is already within you."
  ]
};

// ══════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════
const S = {
  on: false,
  phase: 0,
  breaths: 0,
  sound: false,
  voice: false,
  journey: 'heart',
  duration: 600,
  elapsed: 0,
  timer: null,
  tickTimer: null,
  audio: null,
  osc: null,
  gain: null,
  hasStarted: false
};

// Load preferences
try {
  const saved = localStorage.getItem('innerafield');
  if(saved){
    const p = JSON.parse(saved);
    S.journey = p.journey || 'heart';
    S.duration = p.duration ?? 600;
    S.sound = p.sound || false;
    S.voice = p.voice || false;
  }
} catch(e){}

// ══════════════════════════════════════════════════════════
// ELEMENTS
// ══════════════════════════════════════════════════════════
const circle = document.getElementById('circle');
const word = document.getElementById('word');
const hint = document.getElementById('hint');
const phase = document.getElementById('phase');
const timerDisplay = document.getElementById('timerDisplay');
const wisdom = document.getElementById('wisdom');
const sessionMsg = document.getElementById('sessionMsg');
const sr = document.getElementById('sr');
const menu = document.getElementById('menu');
const overlay = document.getElementById('overlay');
const toast = document.getElementById('toast');
const donateModal = document.getElementById('donateModal');
const donateTitle = document.getElementById('donateTitle');
const donateQR = document.getElementById('donateQR');
const donateAddress = document.getElementById('donateAddress');
const donateClose = document.getElementById('donateClose');
const menuBtn = document.getElementById('menuBtn');
const menuClose = document.getElementById('menuClose');
const soundBtn = document.getElementById('soundBtn');
const contrastBtn = document.getElementById('contrastBtn');
const voiceToggle = document.getElementById('voiceToggle');
const btcBtn = document.getElementById('btcBtn');
const ethBtn = document.getElementById('ethBtn');

// ══════════════════════════════════════════════════════════
// DATA
// ══════════════════════════════════════════════════════════
const phases = ['inhale','hold-in','exhale','hold-out'];
const words = ['breathe in','hold','release','rest'];
const durations = [4000,4000,4000,4000];

const journeys = {
  heart:     [528,432,396,417],
  awakening: [741,852,963,639],
  grounding: [285,432,174,128],
  unity:     [528,639,111,432],
  peace:     [432,396,417,432]
};

// ══════════════════════════════════════════════════════════
// SAVE PREFERENCES
// ══════════════════════════════════════════════════════════
function savePrefs(){
  try {
    localStorage.setItem('innerafield', JSON.stringify({
      journey: S.journey,
      duration: S.duration,
      sound: S.sound,
      voice: S.voice
    }));
  } catch(e){}
}

// ══════════════════════════════════════════════════════════
// AUDIO ENGINE - OPTIMIZED
// ══════════════════════════════════════════════════════════
function initAudio(){
  if(S.audio) return;
  S.audio = new (window.AudioContext||window.webkitAudioContext)();
  S.gain = S.audio.createGain();
  S.gain.gain.value = 0;
  S.gain.connect(S.audio.destination);
}

function playFreq(hz){
  if(!S.audio) return;
  if(S.osc){
    S.osc.frequency.setTargetAtTime(hz, S.audio.currentTime, 0.6);
  } else {
    S.osc = S.audio.createOscillator();
    S.osc.type = 'sine';
    S.osc.frequency.value = hz;
    S.osc.connect(S.gain);
    S.osc.start();
  }
  S.gain.gain.setTargetAtTime(0.06, S.audio.currentTime, 0.4);
}

function stopAudio(){
  if(S.gain) S.gain.gain.setTargetAtTime(0, S.audio.currentTime, 0.4);
}

// ══════════════════════════════════════════════════════════
// VOICE
// ══════════════════════════════════════════════════════════
function speak(text){
  if(!S.voice || !window.speechSynthesis) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.75;
  u.pitch = 0.85;
  u.volume = 0.6;
  speechSynthesis.speak(u);
}

// ══════════════════════════════════════════════════════════
// BREATHING CYCLE
// ══════════════════════════════════════════════════════════
function setPhase(i){
  S.phase = i;
  const p = phases[i];
  
  circle.className = 'circle breathing ' + p;
  word.textContent = words[i];
  phase.textContent = p.replace('-in',' in').replace('-out',' out');
  sr.textContent = words[i];
  
  speak(words[i]);
  
  if(S.sound && S.audio){
    const freqs = journeys[S.journey];
    playFreq(freqs[i]);
  }
  
  if(i === 2) S.breaths++;
}

function next(){
  const n = (S.phase + 1) % 4;
  setPhase(n);
  S.timer = setTimeout(next, durations[n]);
}

function updateTimer(){
  if(!S.on) return;
  S.elapsed++;
  
  if(S.duration > 0){
    const remaining = S.duration - S.elapsed;
    if(remaining <= 0){
      stop();
      return;
    }
    const min = Math.floor(remaining / 60);
    const sec = remaining % 60;
    timerDisplay.textContent = min + ':' + (sec < 10 ? '0' : '') + sec;
  } else {
    timerDisplay.textContent = 'breath ' + S.breaths;
  }
  
  S.tickTimer = setTimeout(updateTimer, 1000);
}

// ══════════════════════════════════════════════════════════
// START / STOP
// ══════════════════════════════════════════════════════════
function start(){
  if(S.on) return;
  S.on = true;
  S.breaths = 0;
  S.elapsed = 0;
  S.hasStarted = true;
  
  document.body.classList.add('active');
  sessionMsg.classList.remove('show');
  sessionMsg.innerHTML = '';
  hint.style.display = 'none';
  
  const wisdomList = WISDOMS[S.journey];
  wisdom.textContent = wisdomList[Math.floor(Math.random() * wisdomList.length)];
  
  if(S.sound){
    initAudio();
    if(S.audio.state === 'suspended') S.audio.resume();
  }
  
  setPhase(0);
  S.timer = setTimeout(next, durations[0]);
  updateTimer();
  
  sr.textContent = 'Breathing started. ' + words[0];
}

function stop(){
  if(!S.on) return;
  S.on = false;
  
  document.body.classList.remove('active');
  
  clearTimeout(S.timer);
  clearTimeout(S.tickTimer);
  S.timer = null;
  S.tickTimer = null;
  
  circle.className = 'circle';
  word.textContent = 'breathe';
  phase.textContent = '';
  timerDisplay.textContent = '';
  
  stopAudio();
  
  // Session message in wisdom area
  sessionMsg.innerHTML = '<span class="count">✧ ' + S.breaths + ' breaths with Source ✧</span><br>return when you forget.';
  sessionMsg.classList.add('show');
  
  setTimeout(() => {
    sessionMsg.classList.remove('show');
    wisdom.textContent = '';
  }, 6000);
  
  sr.textContent = S.breaths + ' breaths complete. You are infinite.';
}

function toggle(){
  S.on ? stop() : start();
}

// ══════════════════════════════════════════════════════════
// MENU
// ══════════════════════════════════════════════════════════
function openMenu(){
  menu.classList.add('open');
  overlay.classList.add('show');
}

function closeMenu(){
  menu.classList.remove('open');
  overlay.classList.remove('show');
}

// Init menu state from saved preferences
function initMenuState(){
  document.querySelectorAll('[data-journey]').forEach(el => {
    el.classList.toggle('selected', el.dataset.journey === S.journey);
  });
  document.querySelectorAll('[data-time]').forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.time) === S.duration);
  });
  soundBtn.classList.toggle('on', S.sound);
  soundBtn.setAttribute('aria-pressed', S.sound);
  voiceToggle.classList.toggle('on', S.voice);
  voiceToggle.setAttribute('aria-checked', S.voice);
}

// Journey selection
document.querySelectorAll('[data-journey]').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('[data-journey]').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    S.journey = el.dataset.journey;
    savePrefs();
  });
});

// Time selection
document.querySelectorAll('[data-time]').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('[data-time]').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    S.duration = parseInt(el.dataset.time);
    savePrefs();
  });
});

// Voice toggle
voiceToggle.addEventListener('click', () => {
  S.voice = !S.voice;
  voiceToggle.classList.toggle('on', S.voice);
  voiceToggle.setAttribute('aria-checked', S.voice);
  savePrefs();
});

// ══════════════════════════════════════════════════════════
// CONTROLS
// ══════════════════════════════════════════════════════════
menuBtn.addEventListener('click', openMenu);
menuClose.addEventListener('click', closeMenu);
overlay.addEventListener('click', () => {
  closeMenu();
  closeDonateModal();
});

soundBtn.addEventListener('click', () => {
  S.sound = !S.sound;
  soundBtn.classList.toggle('on', S.sound);
  soundBtn.setAttribute('aria-pressed', S.sound);
  savePrefs();
  
  if(S.sound && S.on){
    initAudio();
    if(S.audio.state === 'suspended') S.audio.resume();
    const freqs = journeys[S.journey];
    playFreq(freqs[S.phase]);
  } else if(!S.sound){
    stopAudio();
  }
});

contrastBtn.addEventListener('click', () => {
  document.body.classList.toggle('contrast');
  const on = document.body.classList.contains('contrast');
  contrastBtn.classList.toggle('on', on);
  contrastBtn.setAttribute('aria-pressed', on);
});

// ══════════════════════════════════════════════════════════
// DONATIONS
// ══════════════════════════════════════════════════════════
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(() => {
    showToast('address copied ✓');
  }).catch(() => {
    showToast('copy failed');
  });
}

function showDonateModal(type){
  const addr = type === 'btc' ? CRYPTO.btc : CRYPTO.eth;
  const name = type === 'btc' ? 'BITCOIN' : 'ETHEREUM';
  
  donateTitle.textContent = name;
  donateAddress.textContent = addr;
  donateQR.src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(addr);
  
  donateModal.classList.add('show');
}

function closeDonateModal(){
  donateModal.classList.remove('show');
}

btcBtn.addEventListener('click', () => showDonateModal('btc'));
ethBtn.addEventListener('click', () => showDonateModal('eth'));
donateClose.addEventListener('click', closeDonateModal);
donateAddress.addEventListener('click', () => copyToClipboard(donateAddress.textContent));

// ══════════════════════════════════════════════════════════
// EVENTS
// ══════════════════════════════════════════════════════════
circle.addEventListener('click', toggle);
circle.addEventListener('keydown', e => {
  if(e.key === 'Enter' || e.key === ' '){
    e.preventDefault();
    toggle();
  }
});

document.addEventListener('keydown', e => {
  if(e.key === ' ' && document.activeElement === document.body){
    e.preventDefault();
    toggle();
  }
  if(e.key === 'Escape'){
    if(donateModal.classList.contains('show')){
      closeDonateModal();
    } else if(menu.classList.contains('open')){
      closeMenu();
    } else if(S.on){
      stop();
    }
  }
});

// Hide hint after first interaction or 8 seconds
setTimeout(() => {
  if(!S.hasStarted) hint.style.opacity = '0';
}, 8000);

// ══════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════
initMenuState();

if(window.matchMedia('(prefers-contrast:more)').matches){
  document.body.classList.add('contrast');
  contrastBtn.classList.add('on');
  contrastBtn.setAttribute('aria-pressed', 'true');
}

})();
</script>

</body>
</html>
